#!/bin/bash
# install-slowdns.sh - SlowDNS Installation
# Usage: ./install-slowdns.sh

# Verify DNS config exists
if [ ! -f /root/nsdomain ]; then
    echo "❌ Error: DNS configuration not found. Run setup-dns.sh first!"
    exit 1
fi

# Install dependencies
echo "⏳ Installing dependencies..."
apt update -y
apt install -y python3 python3-dnslib net-tools dnsutils iptables

# Setup SlowDNS
echo "🔧 Configuring SlowDNS..."
mkdir -p /etc/slowdns
wget -qO /etc/slowdns/server.key "https://raw.githubusercontent.com/fisabiliyusri/SLDNS/main/slowdns/server.key"
wget -qO /etc/slowdns/server.pub "https://raw.githubusercontent.com/fisabiliyusri/SLDNS/main/slowdns/server.pub"
wget -qO /etc/slowdns/sldns-server "https://raw.githubusercontent.com/fisabiliyusri/SLDNS/main/slowdns/sldns-server"
wget -qO /etc/slowdns/sldns-client "https://raw.githubusercontent.com/fisabiliyusri/SLDNS/main/slowdns/sldns-client"
chmod +x /etc/slowdns/{server.key,server.pub,sldns-server,sldns-client}

# Configure services
echo "📝 Creating service files..."
cat > /etc/systemd/system/client-sldns.service << EOF
[Unit]
Description=Client SlowDNS
After=network.target

[Service]
Type=simple
User=root
ExecStart=/etc/slowdns/sldns-client -udp 8.8.8.8:53 --pubkey-file /etc/slowdns/server.pub $(cat /root/nsdomain) 127.0.0.1:2222
Restart=always

[Install]
WantedBy=multi-user.target
EOF

cat > /etc/systemd/system/server-sldns.service << EOF
[Unit]
Description=Server SlowDNS
After=network.target

[Service]
Type=simple
User=root
ExecStart=/etc/slowdns/sldns-server -udp :5300 -privkey-file /etc/slowdns/server.key $(cat /root/nsdomain) 127.0.0.1:2269
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Firewall rules
echo "🔥 Configuring firewall..."
iptables -I INPUT -p udp --dport 5300 -j ACCEPT
iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300
netfilter-persistent save
netfilter-persistent reload

# SSH Configuration
echo "🔒 Adding SSH ports..."
echo "Port 2222" >> /etc/ssh/sshd_config
echo "Port 2269" >> /etc/ssh/sshd_config
sed -i 's/#AllowTcpForwarding yes/AllowTcpForwarding yes/g' /etc/ssh/sshd_config
systemctl restart ssh

# Enable services
echo "🚀 Starting services..."
systemctl daemon-reload
systemctl enable --now client-sldns server-sldns

echo "✅ SlowDNS Installation Complete!"
echo "   SSH Ports: 2222 (Client), 2269 (Server)"
echo "   Check status with: systemctl status client-sldns server-sldns"
